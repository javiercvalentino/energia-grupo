<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ritmo del A√±o</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#97a3b6;
      --text:#e8eefc;
      --line:#233055;
      --chip:#1a2647;

      --o:#ff5c4d;      /* üü† */
      --y:#ffc84a;      /* üü° */
      --g:#63e08a;      /* üü¢ */
      --gg:#18d878;     /* üü¢üî• */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #162447 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px;}
    h1{font-size:20px; margin:0; letter-spacing:.2px; font-weight:800}
    .sub{font-size:12px; color:var(--muted); line-height:1.35}
    .row{display:grid; grid-template-columns: 360px 1fr; gap:14px}
    @media (max-width: 980px){ .row{grid-template-columns:1fr} .groupBtns{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      border-radius:16px;
      padding:14px;
    }
    .card h2{font-size:13px; margin:0 0 10px 0; color:#dbe6ff; letter-spacing:.2px}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, button, textarea{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(17,26,46,.75);
      color:var(--text);
      padding:10px 11px;
      outline:none;
    }
    input::placeholder{color:#6f7c95}
    button{
      cursor:pointer;
      background: linear-gradient(180deg, rgba(110,168,255,.25), rgba(110,168,255,.12));
      border:1px solid rgba(110,168,255,.30);
      font-weight:600;
    }
    button.secondary{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      font-weight:600;
    }
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .groupRow{display:flex; flex-direction:column; gap:8px}
    .groupBtns{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
    .groupBtns button{width:100%; white-space:nowrap}
.hr{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .tiny{font-size:11px; color:var(--muted)}
    .list{display:flex; flex-direction:column; gap:8px}
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px; border-radius:12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .item b{font-size:13px}
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      padding:5px 10px;
      min-width:72px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:11px; color:#cfe0ff;
      white-space:nowrap;
    }
    .danger{border-color: rgba(255,140,140,.35) !important}

    /* Month axis + band */
    .axis{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      align-items:center;
      height:26px;
      margin-bottom:8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow:hidden;
    }
    .axis .mcell{
      display:flex;
      align-items:center;
      justify-content:center;
      height:100%;
    }
    .axis .mcell span{
      font-size:11px;
      color:#cfe0ff;
      padding:2px 6px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      line-height:1;
      white-space:nowrap;
    }


    .band{
      display:grid;
      grid-template-columns: repeat(365, 1fr);
      gap:1px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      overflow:hidden;
    }
    .dayCell{height:18px; background:#222; position:relative}
    .dayCell.sel{outline:2px solid rgba(255,255,255,.75); outline-offset:-2px}

    .panelTop{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin-bottom:10px;}
    .big{font-size:34px; line-height:1; font-weight:800; letter-spacing:-.8px;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    \.dot{width:18px; height:18px; border-radius:999px; background:var(--g)}
    .muted{color:var(--muted)}
    .mono{font-variant-numeric: tabular-nums}
    .sliderRow{display:flex; gap:12px; align-items:center; margin-top:10px}
    input[type="range"]{padding:0; height:30px; background:transparent; border:none}
    .footerBtns{display:flex; gap:10px; flex-wrap:wrap}

    .windows{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      margin-top:10px;
    }
    .winCard{
      padding:10px;
      border-radius:12px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .winCard .left{display:flex; flex-direction:column; gap:2px}
    .winCard .right{display:flex; align-items:center; gap:8px; white-space:nowrap}

    .helpBox{
      padding:12px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
    }
    .helpBox h3{
      margin:0 0 8px 0;
      font-size:12px;
      color:#dbe6ff;
      letter-spacing:.2px;
      text-transform: uppercase;
    }
    .helpBox ol{
      margin:0;
      padding-left:18px;
      display:grid;
      gap:6px;
    }
    .helpBox li{color: var(--text); font-size:12px; line-height:1.35}
    
    .minmaxBox{
      text-align:center;
      width:240px;            /* ancho fijo para evitar que el cuadro se mueva */
      min-width:240px;
      max-width:240px;
    }

    .chips{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .chipMini{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:11px;
      color:#cfe0ff;
      white-space:nowrap;
      line-height:1;
    }
    .divider{
      height:1px;
      background: rgba(255,255,255,.10);
      margin:10px 0;
      border-radius:999px;
    }
    
    #harmonyHint{display:block; min-height:14px;} /* reserva espacio para texto */
.bar{
      height:8px;
      width:180px;
      max-width:100%;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      overflow:hidden;
      margin:8px auto 0 auto; /* siempre mismo largo y centrada */
    }

    .bar span{display:block;height:100%;width:0%;}

    .bar > span{
      display:block;
      height:100%;
      width:0%;
      background: rgba(255,255,255,.35);
      border-radius:999px;
      transition: width .18s ease;
    }
    .minmaxBox #minMax{font-size:16px; font-weight:700; margin-top:2px}
    .minmaxBox #minMaxNames{margin-top:4px}

    .helpBox .legend{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size:11px;
      line-height:1.35;
    }
  
    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modalOverlay.hidden{ display:none; }
    .modalCard{
      width:min(520px, 96vw);
      background:linear-gradient(180deg, #121c32, #0f172a);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.45);
      padding:16px;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .modalTitle{ font-weight:800; letter-spacing:.2px; }
    .modalClose{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
    }
    .modalActions{
      display:flex; gap:10px; justify-content:flex-end;
      margin-top:12px;
    }
    .modalHint{ margin-top:6px; }
    .modalError{
      color:#ffb3b3;
      margin-top:8px;
      font-size:12px;
      display:none;
    }

  
    .dayCell{ position: relative; }
    .dayCell.bday::after{
      content:"";
      position:absolute;
      top: 3px;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      box-shadow: 0 0 8px rgba(255,255,255,.35);
      opacity: .9;
    }


    /* --- Personas: nombre largo + acciones fijas a la derecha (sin corrimientos) --- */
    .personRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width:100%;
      min-width:0;
    }
    .personLeft{ flex:1 1 auto; min-width:0; }
    .personName{
      display:block;
      font-weight:700;
      font-size:13px;
      line-height:1.15;
      white-space: normal;
      word-break: break-word;
    }
    .personDate{
      font-size:12px;
      color: var(--muted);
      margin-top:2px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
    }
    .personActions{
      flex:0 0 auto;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }
    .personActions .pill{
      min-width:62px;
      padding:5px 9px;
      font-size:11px;
    }
    .personActions button{
      padding:8px 10px;
      font-size:12px;
      border-radius:12px;
      width:84px;
    }
    @media (max-width:560px){
      .personActions{ flex-wrap:wrap; justify-content:flex-end; }
      .personActions button{ width:auto; min-width:78px; }
    }


    /* --- Ajuste fino: botones Editar/Quitar m√°s chicos --- */
    .personActions button{
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 10px;
      width: 72px;
    }
    @media (max-width:560px){
      .personActions button{
        padding: 6px 8px;
        font-size: 11px;
        min-width: 68px;
      }
    }


    /* --- Orden: alineado (sin sobresalir) y con aire respecto a la lista --- */
    .peopleOrderRow{
      margin-bottom: 14px;
    }
    .peopleOrderRow > div{
      width: 100%;
      min-width: 0;
    }
    #sortPeople{
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      display: block;
      margin: 0;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      /* Importante: evitar el "extra" visual que hace que parezca m√°s ancho */
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-clip: padding-box;
    }
    /* Flecha est√©tica sin afectar el ancho */
    .peopleOrderRow .peopleOrderArrow{
      position: relative;
    }
    .peopleOrderRow .peopleOrderArrow::after{
      content: "‚ñæ";
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255,255,255,.70);
      pointer-events: none;
      font-size: 14px;
    }
    .peopleOrderRow .peopleOrderArrow #sortPeople{
      padding-right: 36px;
    }

    /* --- Sem√°foro anual: un poco m√°s presente (sin apagar colores) --- */
    .band{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.12);
    }

    /* --- Cumples en el sem√°foro: marca est√©tica (üéÇ) --- */
    .dayCell.bday::after{
      content: "üéÇ";
      position: absolute;
      top: -9px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      line-height: 1;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,.55));
      pointer-events: none;
    }
    /* peque√±o "palo" para que se entienda la marca */
    .dayCell.bday::before{
      content: "";
      position: absolute;
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 6px;
      background: rgba(255,255,255,.75);
      border-radius: 2px;
      opacity: .65;
      pointer-events: none;
    }


    /* --- Orden: ancho perfecto dentro del panel (sin desborde horizontal) --- */
    .peopleOrderRow{
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin-top: 10px;
      margin-bottom: 16px; /* aire antes de la lista */
    }
    .peopleOrderArrow{
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      overflow: hidden; /* recorta cualquier "extra" nativo del select */
      border-radius: 16px;
    }
    #sortPeople{
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      display: block;
      min-width: 0;
      margin: 0;
      /* eliminamos apariencia nativa que suele desbordar en mobile */
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    /* --- Cumples en el sem√°foro: banderita minimalista --- */
    .dayCell{ position: relative; }
    .dayCell.bday::before{
      content:"";
      position:absolute;
      left:50%;
      top:-8px;
      transform: translateX(-50%);
      width:1px;
      height:10px;
      background: rgba(255,255,255,.75);
      border-radius: 1px;
      pointer-events:none;
    }
    .dayCell.bday::after{
      content:"";
      position:absolute;
      left:50%;
      top:-8px;
      transform: translateX(0);
      width:0;height:0;
      border-top:4px solid transparent;
      border-bottom:4px solid transparent;
      border-left:6px solid rgba(255,214,110,.95);
      filter: drop-shadow(0 1px 1px rgba(0,0,0,.35));
      pointer-events:none;
    }


/* === Cumplea√±os visibles sobre el sem√°foro === */
.dayCell{
  position: relative;
}
.dayCell.bday::after{
  content: "üéÇ";
  position: absolute;
  top: -18px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  cursor: pointer;
}
.dayCell.bday:hover::before{
  content: attr(data-bday);
  position: absolute;
  top: -40px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(20,25,35,.95);
  color: #fff;
  font-size: 11px;
  padding: 4px 8px;
  border-radius: 8px;
  white-space: nowrap;
  box-shadow: 0 4px 10px rgba(0,0,0,.35);
  pointer-events: none;
  z-index: 10;
}


    /* --- Sem√°foro: resaltar HOY (gu√≠a visual) --- */
    .dayCell.today{
      outline: 2px solid rgba(255,255,255,.85);
      outline-offset: -2px;
      box-shadow: 0 0 0 3px rgba(0,0,0,.28) inset;
    }


/* --- Pulido: Nombre del grupo con m√°s jerarqu√≠a --- */
#groupTitle{
  font-size: 18px;
  font-weight: 700;
  letter-spacing: .2px;
  margin-bottom: 2px;
}
@media (max-width: 560px){
  #groupTitle{ font-size: 19px; }
}

/* --- "Qu√© es y qu√© no es" (link + modal) --- */
.aboutLink{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.92);
  text-decoration: none;
  cursor: pointer;
  user-select: none;
}
.aboutLink:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
.aboutLink .kicker{ opacity: .9; }
.aboutLink small{ color: rgba(255,255,255,.70); font-weight: 500; }

.aboutOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 18px;
  z-index: 9999;
}
.aboutOverlay.show{ display: flex; }
.aboutModal{
  width: min(860px, 100%);
  max-height: min(78vh, 720px);
  overflow: auto;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(18,22,30,.96);
  box-shadow: 0 20px 60px rgba(0,0,0,.55);
  padding: 16px 16px 14px;
}
.aboutHeader{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap: 12px;
  margin-bottom: 10px;
}
.aboutHeader h3{
  margin: 0;
  font-size: 16px;
  letter-spacing: .2px;
}
.aboutClose{
  border-radius: 12px;
  padding: 8px 10px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  color: rgba(255,255,255,.92);
  cursor: pointer;
}
.aboutClose:hover{ background: rgba(255,255,255,.06); }
.aboutBody{
  color: rgba(255,255,255,.88);
  font-size: 13px;
  line-height: 1.45;
}
.aboutBody h4{
  margin: 14px 0 6px;
  font-size: 13px;
  color: rgba(255,255,255,.95);
}
.aboutBody ul{ margin: 8px 0 0 18px; }
.aboutBody li{ margin: 4px 0; }
.aboutBody .mutedP{ color: rgba(255,255,255,.72); }
.aboutBody .note{
  display:inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  margin-left: 6px;
  font-size: 12px;
}


/* --- About modal (Qu√© es y qu√© no es): pulido final --- */
.aboutModal{
  display:flex;
  flex-direction: column;
  max-height: min(78vh, 720px);
}
.aboutHeader{
  padding: 18px 18px 8px 18px;
}
.aboutTitle{
  font-size: 24px;
  font-weight: 800;
  letter-spacing: .2px;
}
.aboutBody{
  padding: 12px 18px 10px 18px;
  overflow: auto;
}
.aboutBody h4{
  margin: 18px 0 10px;
  font-size: 14px;
  letter-spacing: .2px;
  text-transform: none;
}
.aboutBody ul{
  margin: 8px 0 0 18px;
}
.aboutBody li{
  margin: 6px 0;
}
.aboutFooter{
  padding: 12px 18px 18px 18px;
  display:flex;
  justify-content:flex-end;
  gap:10px;
  border-top: 1px solid rgba(255,255,255,.08);
}


/* --- Accesibilidad: tipograf√≠as m√°s c√≥modas (especialmente en celular) --- */
:root{
  --font-base: 16px;     /* desktop/base */
  --font-mobile: 18px;   /* mobile */
  --font-small: 14px;
  --font-xsmall: 13px;
}
html{ -webkit-text-size-adjust: 100%; }

body{
  font-size: var(--font-base);
  line-height: 1.35;
}

/* Textos secundarios */
.sub{ font-size: var(--font-small); }
.label, .hint, .muted, .legend, .privacy, .note{ font-size: var(--font-small); }
.pill, .chip, .badge{ font-size: var(--font-xsmall); }

/* Controles: clave para no necesitar zoom */
input, select, textarea, button{
  font-size: 15px;
}

/* Mobile: un escal√≥n m√°s grande + evita zoom en iOS (>=16px en inputs) */
@media (max-width: 720px){
  body{ font-size: var(--font-mobile); }
  h1, .title{ font-size: 22px; }
  .sub{ font-size: 14px; }
  .pill, .chip, .badge{ font-size: 12px; }
  input, select, textarea, button{ font-size: 16px; }
}

</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Ritmo del A√±o</h1>
      <div class="sub">mini web-app local ¬∑ guardado autom√°tico en tu navegador</div>
    </div>
  </header>

  <div class="row">
    <!-- LEFT: Data -->
    <div class="card">
      <h2>Grupos</h2>
      <div class="groupRow">
        <div>
          <label>Seleccionar grupo</label>
          <select id="groupSelect"></select>
        </div>
        <div class="groupBtns">
          <button class="secondary" id="newGroupBtn">Nuevo grupo</button>
          <button class="secondary" id="renameGroupBtn">Renombrar</button>
          <button class="danger" id="deleteGroupBtn">Eliminar</button>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Agregar persona al grupo</h2>
      <div class="grid2">
        <div>
          <label>Nombre</label>
          <input id="pName" placeholder="Ej: Roque" />
        </div>
        <div class="grid2" style="grid-template-columns:1fr 1fr; gap:8px">
          <div>
            <label>D√≠a</label>
            <input id="pDay" type="number" min="1" max="31" placeholder="1" />
          </div>
          <div>
            <label>Mes</label>
            <input id="pMonth" type="number" min="1" max="12" placeholder="2" />
          </div>
        </div>
      </div>
      <div style="margin-top:10px;">
        <button id="addPersonBtn">Agregar</button>
        <div class="tiny" id="addHint" style="margin-top:6px;"></div>
      </div>

      <div class="hr"></div>

      <h2>Personas del grupo</h2>
          <div class="peopleOrderRow" style="margin-top:10px">
            <div>
              <label style="margin-bottom:6px;">Orden</label>
              <div class="peopleOrderArrow"><select id="sortPeople">
                <option value="Ingreso">Ingreso</option>
                <option value="Nombre">Nombre</option>
                <option value="Cumple">Cumple</option>
              </select></div>
            </div>
          </div>

      <div class="list" id="peopleList"></div>

      <div class="hr"></div>

      <h2>Backup</h2>
      <div class="footerBtns">
        <button class="secondary" id="exportBtn">Exportar respaldo</button>
        <button class="secondary" id="exportGroupBtn">Exportar grupo</button>
        <button class="secondary" id="importBtn">Importar respaldo</button>
        <button class="secondary danger" id="resetBtn">Reset (este dispositivo)</button>
      </div>
      <input id="fileInput" type="file" accept="application/json" style="display:none" />
</div>

    <!-- RIGHT: View -->
    <div class="card">
      <div class="panelTop">
        <div>
          <div class="muted" id="groupTitle">Grupo</div>
          <div class="big mono" id="avgBig">‚Äî</div>
          <div class="badge" style="margin-top:10px;">
            <span class="dot" id="dot"></span>
            <span class="mono" id="dayLabel">D√≠a ‚Äî</span>
            <span class="muted" id="dateLabel">‚Äî/‚Äî</span>
          </div>
        </div>
        <div class="minmaxBox">
          <div class="tiny">Min / Max del d√≠a</div>
          <div class="mono" id="minMax">‚Äî</div>
          <div class="tiny muted" id="minMaxNames">‚Äî</div>

          <div class="chips" id="minMaxChips" aria-label="Qui√©n est√° m√°s bajo y m√°s alto hoy">
            <span class="chipMini" id="chipMin">‚¨á ‚Äî</span>
            <span class="chipMini" id="chipMax">‚¨Ü ‚Äî</span>
          </div>

          <div class="divider"></div>

          <div class="tiny">Armon√≠a del d√≠a</div>
          <div class="mono" id="harmonyVal">‚Äî</div>
          <div class="bar" aria-hidden="true"><span id="harmonyBar"></span></div>
          <div class="tiny muted" id="harmonyHint">‚Äî</div>
        </div>
      </div>

      <div class="grid2" style="grid-template-columns: 1fr 180px; align-items:end;">
        <div>
          <h2 style="margin:0 0 8px 0;">Sem√°foro anual</h2>
          <div class="axis" id="axis"></div>
          <div class="band" id="band"></div>
        </div>
        <div>
          <label>Ventana (d√≠as)</label>
          <select id="windowLen">
            <option value="7">7 d√≠as</option>
            <option value="10">10 d√≠as</option>
            <option value="14">14 d√≠as</option>
          </select>
        </div>
      </div>

      <div class="sliderRow">
        <div class="pill mono" id="doyPill">D√≠a 1</div>
        <input id="doyRange" type="range" min="1" max="365" value="1" />
        <button class="secondary" id="todayBtn" style="max-width:140px;">Ir a HOY</button>
      </div>

      <div class="hr"></div>

      <div class="grid2" style="grid-template-columns:1fr 1fr; gap:10px">
        <div>
          <h2 style="margin:0 0 8px 0;">Mejores ventanas</h2>
          <div class="windows" id="bestWins"></div>
        </div>
        <div>
          <h2 style="margin:0 0 8px 0;">Peores ventanas</h2>
          <div class="windows" id="worstWins"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="helpBox" id="helpBox">
        <h3>C√≥mo usar</h3>
        <ol>
          <li><b>Cre√° un grupo</b> (familia, amigos, equipo) y pon√©le un nombre.</li>
          <li><b>Agreg√° personas</b> con su fecha de nacimiento (d√≠a y mes).</li>
          <li><b>Explor√° el a√±o</b> usando el sem√°foro o el control de d√≠a.</li>
          <li><b>Mir√° el promedio</b> y el <b>Min/Max del d√≠a</b> para entender el ritmo del grupo.</li>
          <li><b>Us√° las ventanas</b> (mejores/peores) como referencia para elegir timing.</li>
        </ol>
<div class="legend">
          <div><b>Leyenda de colores (promedio)</b>: üü† &lt;55 ¬∑ üü° 55‚Äì70 ¬∑ üü¢ 70‚Äì85 ¬∑ üü¢üî• ‚â•85</div>
          <div style="margin-top:6px;">Modelo simb√≥lico de ciclos: no predice futuro; ayuda a elegir momentos.</div>
          <div style="margin-top:6px;">Privacidad: los datos se guardan <b>solo en tu dispositivo</b>. Pod√©s <b>exportar/importar JSON</b> para compartir con familiares o amigos.

        <button class="aboutLink" id="aboutBtn" type="button" aria-haspopup="dialog" aria-controls="aboutOverlay">
          <span class="kicker">‚ÑπÔ∏è Qu√© es y qu√© no es</span>
        </button>
</div>
        </div>
      </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal (Editar persona / Renombrar grupo) -->
  <div id="modalOverlay" class="modalOverlay hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalCard">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">Editar</div>
        <button class="modalClose" id="modalCloseBtn" title="Cerrar">‚úï</button>
      </div>

      <div id="modalPersonFields">
        <div class="grid2">
          <div>
            <label>Nombre</label>
            <input id="mPersonName" placeholder="Ej: Roque" />
          </div>
          <div class="grid2" style="grid-template-columns:1fr 1fr; gap:8px">
            <div>
              <label>D√≠a</label>
              <input id="mPersonDay" type="number" inputmode="numeric" min="1" max="31" />
            </div>
            <div>
              <label>Mes</label>
              <input id="mPersonMonth" type="number" inputmode="numeric" min="1" max="12" />
            </div>
          </div>
        </div>
        <div class="tiny muted modalHint">Tip: si cambi√°s d√≠a/mes, el ‚ÄúD√≠a X‚Äù se actualiza autom√°ticamente.</div>
      </div>

      <div id="modalGroupFields" style="display:none;">
        <label>Nombre del grupo</label>
        <input id="mGroupName" placeholder="Ej: Familia" />
      </div>

      <div id="modalError" class="modalError"></div>

      <div class="modalActions">
        <button class="secondary" id="modalCancelBtn">Cancelar</button>
        <button class="primary" id="modalSaveBtn">Guardar</button>
      </div>
    </div>
  </div>


<script>
  "use strict";

  let sortMode = "Ingreso";

  // ---------- Config ----------
  const STORAGE_KEY = "energia_grupo_web_v2";

  // A√±o gen√©rico (no bisiesto)
  const monthStarts = [0,31,59,90,120,151,181,212,243,273,304,334];
  const monthNames = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"]; 
  const maxDaysPerMonth = [31,28,31,30,31,30,31,31,30,31,30,31];

  // Energy curve (piecewise linear), age = 0..365 since birthday.
  const curvePts = [
    [0,50],[60,70],[150,85],[210,100],[270,70],[330,45],[365,30]
  ];

  // ---------- Helpers ----------
  function doyFromDM(day, month){
    return monthStarts[month-1] + day; // 1..365
  }

  function doyToday(){
    const now = new Date();
    const d = now.getDate();
    const m = now.getMonth()+1;
    return doyFromDM(d,m);
  }


  function dateFromDoy(doy){
    const base = new Date(2001,0,1);
    const dt = new Date(base.getTime() + (doy-1)*24*3600*1000);
    const dd = String(dt.getDate()).padStart(2,"0");
    const mm = String(dt.getMonth()+1).padStart(2,"0");
    return `${dd}/${mm}`;
  }

  function dayOfYearToday(){
    const now = new Date();
    const start = new Date(now.getFullYear(),0,1);
    const doy = Math.floor((now - start)/(24*3600*1000)) + 1;
    return Math.min(365, Math.max(1, doy));
  }

  function energyFromAge(age){
    for(let i=0;i<curvePts.length-1;i++){
      const [x1,y1]=curvePts[i], [x2,y2]=curvePts[i+1];
      if(age <= x2){
        const t = (age - x1)/(x2-x1);
        return y1 + t*(y2-y1);
      }
    }
    return curvePts[curvePts.length-1][1];
  }

  function ageInCycle(doy, birthdayDoy){
    return (doy >= birthdayDoy) ? (doy - birthdayDoy) : (doy - birthdayDoy + 365);
  }

  function getCSS(varName){
    return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
  }

  function colorBucket(avg){
    if(avg === null) return { label:"‚Äî", fill:"#222", dot:"#777" };
    if(avg < 55) return { label:"üü†", fill:getCSS("--o"), dot:getCSS("--o") };
    if(avg < 70) return { label:"üü°", fill:getCSS("--y"), dot:getCSS("--y") };
    if(avg < 85) return { label:"üü¢", fill:getCSS("--g"), dot:getCSS("--g") };
    return { label:"üü¢üî•", fill:getCSS("--gg"), dot:getCSS("--gg") };
  }


  function harmonyDescriptor(h){
    if(h === null) return { text:"‚Äî", dot:"#777" };
    if(h >= 75) return { text:"alineados", dot:getCSS("--g") };
    if(h >= 55) return { text:"medianamente alineados", dot:getCSS("--y") };
    return { text:"desparejos", dot:getCSS("--o") };
  }

  function clampInt(n, min, max){
    const x = Number(n);
    if(!Number.isFinite(x)) return null;
    return Math.min(max, Math.max(min, Math.trunc(x)));
  }

  // ---------- Data model ----------
  // data = { groups: [{id, name, people:[{id,name,day,month}]}], lastGroupId }
  function defaultData(){
    // Gen√©rico: cada usuario crea lo suyo. Dejo 1 grupo vac√≠o para que no parezca "roto".
    return {
      groups: [ { id: "G001", name: "Mi grupo", people: [] } ],
      lastGroupId: "G001"
    };
  }

  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultData();
      const d = JSON.parse(raw);
      if(!d.groups || !Array.isArray(d.groups) || d.groups.length === 0) return defaultData();
      return d;
    }catch(e){
      return defaultData();
    }
  }

  

  function loadExampleIntoCurrentGroup(){
    const g = currentGroup();
    if(!g) return;

    // Solo carga ejemplo si est√° vac√≠o (para evitar pisar datos)
    if(Array.isArray(g.people) && g.people.length > 0){
      alert("Este grupo ya tiene personas. Si quer√©s ver el ejemplo, cre√° un grupo nuevo vac√≠o y cargalo ah√≠.");
      return;
    }

    g.people = [
      { id: "P_EX_1", name: "Ana", day: 15, month: 3 },
      { id: "P_EX_2", name: "Bruno", day: 2, month: 7 },
      { id: "P_EX_3", name: "Carla", day: 21, month: 11 },
    ];

    saveData();
    recomputeAndRender();
  }
function saveData(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.data));
  }

  // ---------- UI State ----------
  const state = {
    data: loadData(),
    selectedGroupId: null,
    selectedDoy: 1,
    cache: {
      avg: new Array(365).fill(null),
      min: new Array(365).fill(null),
      max: new Array(365).fill(null),
      minName: new Array(365).fill(""),
      maxName: new Array(365).fill(""),
    }
  };

  // ---------- Elements ----------
  const el = {
    groupSelect: document.getElementById("groupSelect"),
    newGroupBtn: document.getElementById("newGroupBtn"),
    renameGroupBtn: document.getElementById("renameGroupBtn"),
    deleteGroupBtn: document.getElementById("deleteGroupBtn"),
    modalOverlay: document.getElementById("modalOverlay"),
    modalTitle: document.getElementById("modalTitle"),
    modalCloseBtn: document.getElementById("modalCloseBtn"),
    modalCancelBtn: document.getElementById("modalCancelBtn"),
    modalSaveBtn: document.getElementById("modalSaveBtn"),
    modalError: document.getElementById("modalError"),
    modalPersonFields: document.getElementById("modalPersonFields"),
    mPersonName: document.getElementById("mPersonName"),
    mPersonDay: document.getElementById("mPersonDay"),
    mPersonMonth: document.getElementById("mPersonMonth"),
    modalGroupFields: document.getElementById("modalGroupFields"),
    mGroupName: document.getElementById("mGroupName"),
    pName: document.getElementById("pName"),
    pDay: document.getElementById("pDay"),
    pMonth: document.getElementById("pMonth"),
    addPersonBtn: document.getElementById("addPersonBtn"),
    addHint: document.getElementById("addHint"),
    peopleList: document.getElementById("peopleList"),
    sortPeople: document.getElementById("sortPeople"),

    axis: document.getElementById("axis"),
    band: document.getElementById("band"),
    doyRange: document.getElementById("doyRange"),
    doyPill: document.getElementById("doyPill"),
    todayBtn: document.getElementById("todayBtn"),

    groupTitle: document.getElementById("groupTitle"),
    avgBig: document.getElementById("avgBig"),
    dot: document.getElementById("dot"),
    dayLabel: document.getElementById("dayLabel"),
    dateLabel: document.getElementById("dateLabel"),
    minMax: document.getElementById("minMax"),
    minMaxNames: document.getElementById("minMaxNames"),

    chipMin: document.getElementById("chipMin"),
    chipMax: document.getElementById("chipMax"),
    harmonyVal: document.getElementById("harmonyVal"),
    harmonyBar: document.getElementById("harmonyBar"),
    harmonyHint: document.getElementById("harmonyHint"),

    windowLen: document.getElementById("windowLen"),
    bestWins: document.getElementById("bestWins"),
    worstWins: document.getElementById("worstWins"),

    exportBtn: document.getElementById("exportBtn"),
    exportGroupBtn: document.getElementById("exportGroupBtn"),
    importBtn: document.getElementById("importBtn"),
    resetBtn: document.getElementById("resetBtn"),
    fileInput: document.getElementById("fileInput"),
  };

  // ---------- Core selectors ----------
  function currentGroup(){
    return state.data.groups.find(g => g.id === state.selectedGroupId) || state.data.groups[0];
  }

  function ensureSelectedGroup(){
    if(!state.selectedGroupId){
      state.selectedGroupId = state.data.lastGroupId || (state.data.groups[0]?.id ?? "G001");
    }
    if(!state.data.groups.find(g=>g.id===state.selectedGroupId) && state.data.groups.length){
      state.selectedGroupId = state.data.groups[0].id;
    }
  }

  // ---------- Computation ----------
  function computeBand(){
    const g = currentGroup();
    const people = Array.isArray(g.people) ? g.people : [];
    const n = people.length;

    const avgArr = new Array(365).fill(null);
    const minArr = new Array(365).fill(null);
    const maxArr = new Array(365).fill(null);
    const minName = new Array(365).fill("");
    const maxName = new Array(365).fill("");

    if(n === 0){
      state.cache = { avg: avgArr, min: minArr, max: maxArr, minName, maxName };
      return;
    }

    const bdays = people.map(p => ({
      name: p.name,
      doy: doyFromDM(p.day, p.month)
    }));

    for(let doy=1; doy<=365; doy++){
      let sum=0;
      let mn=1e9, mx=-1e9;
      let mnN="", mxN="";

      for(const b of bdays){
        const age = ageInCycle(doy, b.doy);
        const e = energyFromAge(age);
        sum += e;
        if(e < mn){ mn = e; mnN = b.name; }
        if(e > mx){ mx = e; mxN = b.name; }
      }

      const avg = sum / n;
      avgArr[doy-1] = avg;
      minArr[doy-1] = mn;
      maxArr[doy-1] = mx;
      minName[doy-1] = mnN;
      maxName[doy-1] = mxN;
    }

    state.cache = { avg: avgArr, min: minArr, max: maxArr, minName, maxName };
  }

  // Rolling windows: top/bottom K non-overlapping windows.
  function computeWindows(windowLen, k=3){
    const avgArr = state.cache.avg;
    const n = avgArr.filter(v => v !== null).length;
    if(n === 0) return { best: [], worst: [] };

    const L = windowLen;
    const scores = [];

    // Precompute prefix sum for speed
    const prefix = [0];
    for(let i=0;i<365;i++){
      prefix.push(prefix[prefix.length-1] + (avgArr[i] ?? 0));
    }

    // Circular windows on generic year (wrap-around)
    for(let start=1; start<=365; start++){
      let sum=0;
      if(start + L - 1 <= 365){
        sum = prefix[start+L-1] - prefix[start-1];
      }else{
        const firstPart = prefix[365] - prefix[start-1];
        const rest = (start + L - 1) - 365;
        const secondPart = prefix[rest] - prefix[0];
        sum = firstPart + secondPart;
      }
      scores.push({ start, end: ((start+L-2)%365)+1, avg: sum / L });
    }

    // Non-overlap selection: pick best, then block a zone of L days around start..end.
    function selectNonOverlapping(sorted){
      const picked = [];
      const blocked = new Array(366).fill(false); // 1..365

      function markBlocked(start){
        for(let i=0;i<L;i++){
          const d = ((start+i-1)%365)+1;
          blocked[d] = true;
        }
      }

      for(const s of sorted){
        // If any day in window is blocked, skip
        let ok = true;
        for(let i=0;i<L;i++){
          const d = ((s.start+i-1)%365)+1;
          if(blocked[d]){ ok = false; break; }
        }
        if(!ok) continue;

        picked.push(s);
        markBlocked(s.start);
        if(picked.length >= k) break;
      }
      return picked;
    }

    const bestSorted = [...scores].sort((a,b)=> b.avg - a.avg);
    const worstSorted = [...scores].sort((a,b)=> a.avg - b.avg);

    const best = selectNonOverlapping(bestSorted);
    const worst = selectNonOverlapping(worstSorted);

    return { best, worst };
  }

  // ---------- Rendering ----------
  function renderAxis(){
    el.axis.innerHTML = "";
    for(let m=1; m<=12; m++){
      const cell = document.createElement("div");
      cell.className = "mcell";
      const span = document.createElement("span");
      span.textContent = monthNames[m-1];
      cell.appendChild(span);
      el.axis.appendChild(cell);
    }
  }

  function renderGroupSelect(){
    el.groupSelect.innerHTML = "";
    for(const g of state.data.groups){
      const opt = document.createElement("option");
      opt.value = g.id;
      opt.textContent = `${g.name}`;
      el.groupSelect.appendChild(opt);
    }
    el.groupSelect.value = state.selectedGroupId;
  }

  
  // ---------- Modal helpers ----------
  let modalMode = null; // "editPerson" | "renameGroup"
  let modalPersonId = null;

  function openModal(mode, payload){
    modalMode = mode;
    modalPersonId = null;
    el.modalError.style.display = "none";
    el.modalError.textContent = "";

    if(mode === "editPerson"){
      el.modalTitle.textContent = "Editar persona";
      el.modalPersonFields.style.display = "";
      el.modalGroupFields.style.display = "none";

      const p = payload;
      modalPersonId = p.id;
      el.mPersonName.value = p.name || "";
      el.mPersonDay.value = String(p.day ?? "");
      el.mPersonMonth.value = String(p.month ?? "");
      setTimeout(()=> el.mPersonName.focus(), 0);
    }else if(mode === "renameGroup"){
      el.modalTitle.textContent = "Renombrar grupo";
      el.modalPersonFields.style.display = "none";
      el.modalGroupFields.style.display = "";
      el.mGroupName.value = String(payload?.name ?? "");
      setTimeout(()=> el.mGroupName.focus(), 0);
      el.mGroupName.select?.();
    }

    el.modalOverlay.classList.remove("hidden");
  }

  function closeModal(){
    el.modalOverlay.classList.add("hidden");
    modalMode = null;
    modalPersonId = null;
  }

  function showModalError(msg){
    el.modalError.textContent = msg;
    el.modalError.style.display = "block";
  }

function renderPeopleList(){
    const g = currentGroup();
    el.peopleList.innerHTML = "";

    const people = Array.isArray(g.people) ? [...g.people] : [];
    if(sortMode === "Nombre"){
      people.sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "es", {sensitivity:"base"}));
    }else if(sortMode === "Cumple"){
      people.sort((a,b)=> doyFromDM(a.day,a.month) - doyFromDM(b.day,b.month));
    }

    if(!g.people || g.people.length === 0){
      const box = document.createElement("div");
      box.className = "emptyBox";
      box.innerHTML = `
        <div class="emptyTitle">Este grupo est√° vac√≠o</div>
        <div class="tiny muted" style="margin-top:6px; line-height:1.35;">
          ‚Ä¢ Sum√° personas con <b>Nombre + D√≠a + Mes</b>.<br/>
          ‚Ä¢ Luego explor√° el a√±o con el sem√°foro o el control de d√≠a.<br/>
          ‚Ä¢ Si quer√©s entenderlo r√°pido, carg√° un ejemplo.
        </div>
      `;

      const btn = document.createElement("button");
      btn.className = "secondary";
      btn.style.marginTop = "10px";
      btn.textContent = "Cargar ejemplo";
      btn.onclick = () => {
        loadExampleIntoCurrentGroup();
      };

      box.appendChild(btn);
      el.peopleList.appendChild(box);
      return;
    }

    for(const p of people){
      const item = document.createElement("div");
      item.className = "item";

      const row = document.createElement("div");
      row.className = "personRow";

      const left = document.createElement("div");
      left.className = "personLeft";

      const nameEl = document.createElement("span");
      nameEl.className = "personName";
      nameEl.textContent = String(p.name || "");

      const dateEl = document.createElement("div");
      dateEl.className = "personDate";
      dateEl.textContent = `${String(p.day).padStart(2,"0")}/${String(p.month).padStart(2,"0")}`;

      left.appendChild(nameEl);
      left.appendChild(dateEl);

      const actions = document.createElement("div");
      actions.className = "personActions";

      const pill = document.createElement("div");
      pill.className = "pill mono";
      pill.textContent = `D√≠a ${doyFromDM(p.day, p.month)}`;

      const edit = document.createElement("button");
      edit.className = "secondary";
      edit.textContent = "Editar";
      edit.onclick = () => openModal("editPerson", p);

      const del = document.createElement("button");
      del.className = "secondary";
      del.textContent = "Quitar";
      del.onclick = () => {
        if(!confirm(`¬øQuitar a ${p.name} del grupo?`)) return;
        g.people = g.people.filter(x => x.id !== p.id);
        saveData();
        recomputeAndRender();
      };

      actions.appendChild(pill);
      actions.appendChild(edit);
      actions.appendChild(del);

      row.appendChild(left);
      row.appendChild(actions);

      item.appendChild(row);
      el.peopleList.appendChild(item);
    }
  }

  function renderBand(){
    const today = doyToday();
    el.band.innerHTML = "";
    const g = currentGroup();
    const bdaySet = new Set((g.people||[]).map(p=>doyFromDM(p.day,p.month)));
    const bdayNames = Object.create(null);
    for(const p of (g.people||[])){
      const d = doyFromDM(p.day,p.month);
      (bdayNames[d] ||= []).push(p.name);
    }
    for(let i=1;i<=365;i++){
      const div = document.createElement("div");
      div.className = "dayCell";
      if(i === today) div.classList.add("today");
      if(bdaySet.has(i)){
        div.classList.add("bday");
        div.setAttribute("data-bday", "Cumple: " + (bdayNames[i]||[]).join(", "));
      }
      const avg = state.cache.avg[i-1];
      const cb = colorBucket(avg);
      div.style.background = cb.fill || "#222";
      div.title = `D√≠a ${i} (${dateFromDoy(i)}) ‚Äî promedio ${avg?.toFixed(1) ?? "‚Äî"} ${cb.label}` + (bdaySet.has(i) ? `\nCumple: ${(bdayNames[i]||[]).join(", ")}` : "");
      if(i === state.selectedDoy) div.classList.add("sel");
      div.onclick = () => {
        state.selectedDoy = i;
        el.doyRange.value = String(i);
        renderRightPanel();
        renderBand();
      };
      el.band.appendChild(div);
    }
  }

  function renderRightPanel(){
    const g = currentGroup();
    el.groupTitle.textContent = `${g.name}`;

    const doy = state.selectedDoy;
    el.doyPill.textContent = `D√≠a ${doy}`;
    el.dayLabel.textContent = `D√≠a ${doy}`;
    el.dateLabel.textContent = dateFromDoy(doy);

    const avg = state.cache.avg[doy-1];
    const mn = state.cache.min[doy-1];
    const mx = state.cache.max[doy-1];
    const mnN = state.cache.minName[doy-1];
    const mxN = state.cache.maxName[doy-1];

    if(avg === null){
      el.avgBig.textContent = "‚Äî";
      el.dot.style.background = "#777";
      el.minMax.textContent = "‚Äî";
      el.minMaxNames.textContent = "‚Äî";
      el.chipMin.textContent = "‚¨á ‚Äî";
      el.chipMax.textContent = "‚¨Ü ‚Äî";
      el.harmonyVal.textContent = "‚Äî";
      el.harmonyBar.style.width = "0%";
      el.harmonyBar.style.background = "rgba(255,255,255,.35)";
      el.harmonyHint.textContent = "‚Äî";
      return;
    }

    const cb = colorBucket(avg);
    el.avgBig.textContent = `${avg.toFixed(0)}% ${cb.label}`;
    el.dot.style.background = cb.dot;

    el.minMax.textContent = `${mn.toFixed(0)}% / ${mx.toFixed(0)}%`;
    el.minMaxNames.textContent = `${mnN} / ${mxN}`;

    // Chips de lectura r√°pida
    el.chipMin.textContent = `‚¨á ${mnN} ${mn.toFixed(0)}%`;
    el.chipMax.textContent = `‚¨Ü ${mxN} ${mx.toFixed(0)}%`;

    // Armon√≠a del d√≠a (qu√© tan alineado est√° el grupo)
    const spread = Math.max(0, mx - mn);
    const harmony = Math.max(0, Math.min(100, 100 - spread));
    const hd = harmonyDescriptor(harmony);
    el.harmonyVal.textContent = `${harmony.toFixed(0)}%`;
    el.harmonyBar.style.width = `${harmony.toFixed(0)}%`;
    el.harmonyBar.style.background = hd.dot;
    el.harmonyHint.textContent = `${hd.text} (diferencia: ${spread.toFixed(0)} pts)`;
  }

  function renderWindows(){
    const L = parseInt(el.windowLen.value, 10);
    const { best, worst } = computeWindows(L, 3);

    function renderList(container, items, kind){
      container.innerHTML = "";
      if(items.length === 0){
        const d = document.createElement("div");
        d.className = "tiny muted";
        d.textContent = "Agreg√° personas para ver ventanas.";
        container.appendChild(d);
        return;
      }
      for(const w of items){
        const card = document.createElement("div");
        card.className = "winCard";

        const left = document.createElement("div");
        left.className = "left";
        const startDate = dateFromDoy(w.start);
        const endDate = dateFromDoy(w.end);
        const label = `${startDate} ‚Üí ${endDate}`;
        left.innerHTML = `<div class="mono"><b>${label}</b></div><div class="tiny muted">Ventana ${L} d√≠as</div>`;

        const right = document.createElement("div");
        right.className = "right";
        const cb = colorBucket(w.avg);
        const dot = document.createElement("span");
        dot.className = "dot";
        dot.style.background = cb.dot;
        const txt = document.createElement("span");
        txt.className = "mono";
        txt.textContent = `${w.avg.toFixed(0)}% ${cb.label}`;
        right.appendChild(dot);
        right.appendChild(txt);

        card.appendChild(left);
        card.appendChild(right);

        // Click to jump to start day
        card.style.cursor = "pointer";
        card.title = "Click para ir al inicio";
        card.onclick = () => {
          state.selectedDoy = w.start;
          el.doyRange.value = String(state.selectedDoy);
          renderRightPanel();
          renderBand();
        };

        container.appendChild(card);
      }
    }

    renderList(el.bestWins, best, "best");
    renderList(el.worstWins, worst, "worst");
  }

  function recomputeAndRender(){
    renderGroupSelect();
    el.sortPeople.value = sortMode;
    renderPeopleList();
    computeBand();
    renderAxis();
    renderBand();
    renderRightPanel();
    renderWindows();
  }

  // ---------- Safety: basic HTML escape ----------
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- Actions ----------
  el.groupSelect.addEventListener("change", () => {
    state.selectedGroupId = el.groupSelect.value;
    state.data.lastGroupId = state.selectedGroupId;
    saveData();
    recomputeAndRender();
  });

  el.sortPeople.addEventListener("change", () => {
    sortMode = el.sortPeople.value;
    renderPeopleList();
  });

  el.newGroupBtn.addEventListener("click", () => {
    const name = prompt("Nombre del nuevo grupo:", "Mi grupo");
    if(!name) return;

    const nums = state.data.groups
      .map(g => parseInt(g.id.replace("G",""),10))
      .filter(n=>Number.isFinite(n));
    const next = (nums.length ? Math.max(...nums)+1 : 1);
    const id = `G${String(next).padStart(3,"0")}`;

    state.data.groups.push({ id, name: name.trim(), people: [] });
    state.selectedGroupId = id;
    state.data.lastGroupId = id;
    saveData();
    recomputeAndRender();
  })
  el.renameGroupBtn.addEventListener("click", () => {
    const g = currentGroup();
    openModal("renameGroup", g);
  });

  el.deleteGroupBtn.addEventListener("click", () => {
    const g = currentGroup();
    if(!g) return;

    const msg =
      `Eliminar el grupo "${g.name}"?\n\n` +
      `Se perder√°n las personas cargadas en este dispositivo. (Esto no afecta a ning√∫n otro dispositivo.)`;
    if(!confirm(msg)) return;

    state.data.groups = state.data.groups.filter(x => x.id !== g.id);

    // Si no quedan grupos, recreamos el default para que la app nunca quede "vac√≠a"
    if(!state.data.groups.length){
      state.data.groups = [ { id: "G001", name: "Mi grupo", people: [] } ];
      state.selectedGroupId = "G001";
      state.data.lastGroupId = "G001";
    }else{
      state.selectedGroupId = state.data.groups[0].id;
      state.data.lastGroupId = state.selectedGroupId;
    }

    saveData();
    recomputeAndRender();
  });

  // Modal events
  el.modalCloseBtn.addEventListener("click", closeModal);
  el.modalCancelBtn.addEventListener("click", closeModal);
  el.modalOverlay.addEventListener("click", (e) => {
    if(e.target === el.modalOverlay) closeModal();
  });
  document.addEventListener("keydown", (e) => {
    if(!el.modalOverlay.classList.contains("hidden") && e.key === "Escape") closeModal();
  });

  el.modalSaveBtn.addEventListener("click", () => {
    const g = currentGroup();
    if(modalMode === "editPerson"){
      const name = (el.mPersonName.value || "").trim();
      const day = parseInt(el.mPersonDay.value, 10);
      const month = parseInt(el.mPersonMonth.value, 10);

      if(!name) return showModalError("Pon√© un nombre.");
      if(!Number.isFinite(month) || month < 1 || month > 12) return showModalError("El mes debe estar entre 1 y 12.");
      if(!Number.isFinite(day) || day < 1 || day > daysInMonth(month)) return showModalError(`D√≠a inv√°lido para el mes ${month}.`);

      const idx = g.people.findIndex(x => x.id === modalPersonId);
      if(idx === -1) return showModalError("No encontr√© a la persona (¬øse borr√≥?).");

      g.people[idx].name = name;
      g.people[idx].day = day;
      g.people[idx].month = month;

      saveData();
      recomputeAndRender();
      closeModal();
    }else if(modalMode === "renameGroup"){
      const name = (el.mGroupName.value || "").trim();
      if(!name) return showModalError("Pon√© un nombre para el grupo.");
      g.name = name;
      saveData();
      recomputeAndRender();
      closeModal();
    }
  });

;

  el.addPersonBtn.addEventListener("click", () => {
    const name = el.pName.value.trim();
    const day = clampInt(el.pDay.value, 1, 31);
    const month = clampInt(el.pMonth.value, 1, 12);

    el.addHint.textContent = "";

    if(!name || day === null || month === null){
      el.addHint.textContent = "Complet√° nombre, d√≠a y mes.";
      return;
    }

    const maxDays = maxDaysPerMonth[month-1];
    if(day > maxDays){
      el.addHint.textContent = `Ese mes tiene m√°ximo ${maxDays} d√≠as (a√±o gen√©rico).`;
      return;
    }

    const g = currentGroup();
    g.people = Array.isArray(g.people) ? g.people : [];

    // Avoid duplicates by name+date (simple)
    const exists = g.people.some(p =>
      p.name.toLowerCase() === name.toLowerCase() && p.day === day && p.month === month
    );
    if(exists){
      el.addHint.textContent = "Esa persona ya existe en el grupo.";
      return;
    }

    const nums = g.people
      .map(p => parseInt(p.id.replace("P",""),10))
      .filter(n=>Number.isFinite(n));
    const next = (nums.length ? Math.max(...nums)+1 : 1);
    const pid = `P${String(next).padStart(3,"0")}`;

    g.people.push({ id: pid, name, day, month });

    el.pName.value = "";
    el.pDay.value = "";
    el.pMonth.value = "";

    saveData();
    recomputeAndRender();
  });

  el.doyRange.addEventListener("input", () => {
    state.selectedDoy = parseInt(el.doyRange.value,10);
    renderRightPanel();
    renderBand();
  });

  el.todayBtn.addEventListener("click", () => {
    state.selectedDoy = dayOfYearToday();
    el.doyRange.value = String(state.selectedDoy);
    renderRightPanel();
    renderBand();
  });

  el.windowLen.addEventListener("change", () => {
    renderWindows();
  });

  el.exportBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "energia_grupo_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  
  el.exportGroupBtn.addEventListener("click", () => {
    const g = currentGroup();
    if(!g) return;

    // Export "portable": un solo grupo, pensado para compartir/importar sin pisar todo.
    const payload = {
      kind: "singleGroup",
      version: 1,
      exportedAt: new Date().toISOString(),
      group: JSON.parse(JSON.stringify(g))
    };

    const safeName = (g.name || "grupo").toString().trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_\-]/g,"");
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `ritmo_del_ano_${safeName || "grupo"}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

el.importBtn.addEventListener("click", () => {
    el.fileInput.value = "";
    el.fileInput.click();
  });

  el.fileInput.addEventListener("change", async () => {
    const file = el.fileInput.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const d = JSON.parse(text);

      // Caso 1: archivo "portable" de un solo grupo (merge, no pisa todo)
      if(d && d.kind === "singleGroup" && d.group){
        const incoming = d.group;
        incoming.people = Array.isArray(incoming.people) ? incoming.people : [];

        // Generar nuevo ID de grupo para evitar colisiones
        const nums = state.data.groups
          .map(g => parseInt((g.id||"").replace("G",""),10))
          .filter(n=>Number.isFinite(n));
        const next = (nums.length ? Math.max(...nums) : 0) + 1;
        const newId = "G" + String(next).padStart(3,"0");

        const merged = {
          id: newId,
          name: (incoming.name || "Grupo importado").toString(),
          people: incoming.people.map((p, i) => ({
            id: "P" + newId + "_" + String(i+1).padStart(3,"0"),
            name: (p.name || "Persona").toString(),
            day: clampInt(p.day, 1, 31),
            month: clampInt(p.month, 1, 12),
          }))
        };

        // Confirmaci√≥n suave (por si importan sin querer)
        if(!confirm(`¬øImportar el grupo ‚Äú${merged.name}‚Äù a este dispositivo?\n\nSe va a agregar como un grupo nuevo (no reemplaza tus datos).`)) return;

        state.data.groups.push(merged);
        state.selectedGroupId = merged.id;
        state.data.lastGroupId = merged.id;
        saveData();
        recomputeAndRender();
        alert("Grupo importado ‚úÖ");
        return;
      }

      // Caso 2: backup completo (reemplaza)
      if(!d.groups || !Array.isArray(d.groups) || d.groups.length === 0) throw new Error("JSON inv√°lido: falta groups");
      // Basic normalization
      for(const g of d.groups){
        g.people = Array.isArray(g.people) ? g.people : [];
      }
      state.data = d;
      state.selectedGroupId = d.lastGroupId || d.groups[0]?.id || "G001";
      saveData();
      recomputeAndRender();
      alert("Importado OK ‚úÖ");
    }catch(e){
      alert("No pude importar: " + e.message);
    }
  });

  el.resetBtn.addEventListener("click", () => {
    if(!confirm("¬øSeguro? Esto borra los datos guardados en ESTE dispositivo.")) return;
    localStorage.removeItem(STORAGE_KEY);
    state.data = defaultData();
    state.selectedGroupId = state.data.lastGroupId;
    state.selectedDoy = dayOfYearToday();
    saveData();
    recomputeAndRender();
  });

  // ---------- Init ----------
  ensureSelectedGroup();
  state.selectedDoy = dayOfYearToday();
  el.doyRange.value = String(state.selectedDoy);
  recomputeAndRender();


  // --- About modal (Qu√© es y qu√© no es) ---
  window.addEventListener("DOMContentLoaded", ()=>{
    const btn = document.getElementById("aboutBtn");
    const overlay = document.getElementById("aboutOverlay");
    const closeBtn = document.getElementById("aboutClose");

    if(!btn || !overlay || !closeBtn) return;

    function open(){
      overlay.classList.add("show");
      closeBtn.focus?.();
    }
    function close(){
      overlay.classList.remove("show");
      btn.focus?.();
    }

    btn.addEventListener("click", open);
    closeBtn.addEventListener("click", close);

    overlay.addEventListener("click", (e)=>{
      if(e.target === overlay) close();
    });
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape" && overlay.classList.contains("show")) close();
    });
  });

</script>

  <!-- About modal -->
  <div class="aboutOverlay" id="aboutOverlay" aria-hidden="true">

        <div class="aboutModal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
          <div class="aboutHeader">
            <div class="aboutTitle" id="aboutTitle">Qu√© es y qu√© no es</div>
          </div>

          <div class="aboutBody">
            <p><strong>üå± Energ√≠a del Grupo</strong> es una herramienta <strong>simple y visual</strong> para observar c√≥mo var√≠a el ritmo anual de una persona o de un grupo a lo largo de un a√±o gen√©rico (365 d√≠as).</p>

            <p>La idea <strong>no es predecir el futuro</strong>. Es una forma de ayudar a elegir mejores momentos para organizar encuentros, iniciar proyectos o simplemente mirar los ritmos personales y colectivos.</p>

            <h4>‚úÖ Qu√© s√≠ es</h4>
            <ul>
              <li>Una visualizaci√≥n clara del <strong>promedio del grupo</strong> a lo largo del a√±o.</li>
              <li>Una ayuda para pensar <strong>timing</strong> y conversar decisiones con m√°s contexto.</li>
              <li>Una herramienta liviana: funciona en PC y celular, <strong>sin cuentas</strong>.</li>
            </ul>

            <h4>üö´ Qu√© no es</h4>
            <ul>
              <li>No predice eventos.</li>
              <li>No garantiza resultados.</li>
              <li>No reemplaza decisiones personales, m√©dicas, legales ni financieras.</li>
            </ul>

            <h4>üîí Privacidad</h4>
            <ul>
              <li>Los datos se guardan <strong>solo en tu navegador</strong> (local).</li>
              <li>No hay servidores, bases de datos ni cuentas.</li>
              <li>Si quer√©s compartirlo, pod√©s exportar/importar un archivo manualmente.</li>
            </ul>

            <p style="margin-top:14px; opacity:.9">Si te sirve, genial. Y si no, no pasa nada üôÇ</p>
          </div>

          <div class="aboutFooter">
            <button class="secondary" id="aboutClose" type="button">Cerrar</button>
          </div>
        </div>

      </div>
  </div>

</body>
</html>
